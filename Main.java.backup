import com.fazecast.jSerialComm.SerialPort;
import javafx.application.Application;
import javafx.application.Platform;
import javafx.geometry.Insets;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.layout.*;
import javafx.stage.Stage;
import javax.sound.sampled.*;
import java.awt.Desktop;
import java.io.*;
import java.net.*;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.*;
import java.util.concurrent.*;
import java.util.Base64;

public class Main extends Application {
    
    // GUI Components
    private BorderPane root;
    private VBox chatMessages;
    private SerialPort comPort;
    
    // Server Configuration
    private static final int CHAT_PORT = 5555;
    private static final int WEB_PORT = 3000;
    private ServerSocket chatServerSocket;
    private ServerSocket webServerSocket;
    private final List<ClientHandler> connectedClients = new CopyOnWriteArrayList<>();
    private final Map<String, ChatSession> sessions = new ConcurrentHashMap<>();
    private final Map<String, Set<ClientHandler>> sessionClients = new ConcurrentHashMap<>();
    
    // Voice recording
    private TargetDataLine recordingLine;
    private boolean isRecording = false;
    
    // Profile / Avatars
    private ImageView profileAvatarView;
    private List<File> avatarFiles = new ArrayList<>();
    private FlowPane gallery = new FlowPane();
    
    // Web server executor
    private ExecutorService webServerExecutor;
    private boolean webServerRunning = false;

    @Override
    public void start(Stage primaryStage) {
        root = new BorderPane();
        
        // Initialize avatar files
        loadAvatarFiles();
        
        // Start both servers
        startChatServer();
        startWebServer();
        
        // Bottom Navigation Bar
        HBox navBar = new HBox(10);
        navBar.setPadding(new Insets(10));
        Button chatBtn = new Button("üí¨ Text");
        Button profileBtn = new Button("üë§ Profile");
        Button settingsBtn = new Button("‚öôÔ∏è Settings");
        Button webBtn = new Button("üåê Web Interface");

        navBar.getChildren().addAll(chatBtn, profileBtn, settingsBtn, webBtn);
        root.setBottom(navBar);

        // Default Page: Chat
        showChatPage();

        // Navigation actions
        chatBtn.setOnAction(e -> showChatPage());
        profileBtn.setOnAction(e -> showProfilePage());
        settingsBtn.setOnAction(e -> showSettingsPage());
        webBtn.setOnAction(e -> openWebInterface());

        Scene scene = new Scene(root, 500, 700);
        primaryStage.setScene(scene);
        primaryStage.setTitle("Complete Chat Application - Java");
        primaryStage.show();
        
        // Show startup message
        Platform.runLater(() -> {
            addMessage("üöÄ Complete Chat Application Started!", false);
            addMessage("üí¨ Chat Server: Port " + CHAT_PORT, false);
            addMessage("üåê Web Server: http://localhost:" + WEB_PORT, false);
            addMessage("üì± Click 'Web Interface' to open browser", false);
        });
    }
    
    // Load avatar files from assets directory
    private void loadAvatarFiles() {
        File assetsDir = new File("assets");
        if (assetsDir.exists() && assetsDir.isDirectory()) {
            File[] files = assetsDir.listFiles((dir, name) -> 
                name.toLowerCase().endsWith(".jpg") || 
                name.toLowerCase().endsWith(".jpeg") || 
                name.toLowerCase().endsWith(".png") || 
                name.toLowerCase().endsWith(".gif")
            );
            if (files != null) {
                avatarFiles.addAll(Arrays.asList(files));
                
                // Create gallery
                gallery.setHgap(5);
                gallery.setVgap(5);
                gallery.setPadding(new Insets(10));
                
                for (File file : avatarFiles) {
                    ImageView imgView = new ImageView(loadAndRemoveBackground(file));
                    imgView.setFitWidth(50);
                    imgView.setFitHeight(50);
                    imgView.setPreserveRatio(true);
                    imgView.setOnMouseClicked(e -> {
                        profileAvatarView.setImage(imgView.getImage());
                    });
                    gallery.getChildren().add(imgView);
                }
            }
        }
    }
    
    // Start chat server
    private void startChatServer() {
        Thread serverThread = new Thread(() -> {
            try {
                chatServerSocket = new ServerSocket(CHAT_PORT);
                System.out.println("üîå Chat server started on port " + CHAT_PORT);
                
                while (!Thread.currentThread().isInterrupted()) {
                    Socket socket = chatServerSocket.accept();
                    ClientHandler handler = new ClientHandler(socket);
                    connectedClients.add(handler);
                    new Thread(handler, "chat-client-" + socket.getPort()).start();
                }
            } catch (IOException e) {
                System.out.println("Chat server closed: " + e.getMessage());
            }
        }, "chat-server");
        serverThread.setDaemon(true);
        serverThread.start();
    }
    
    // Start web server
    private void startWebServer() {
        webServerExecutor = Executors.newFixedThreadPool(10);
        Thread webServerThread = new Thread(() -> {
            try {
                webServerSocket = new ServerSocket(WEB_PORT);
                webServerRunning = true;
                System.out.println("üåê Web server started on http://localhost:" + WEB_PORT);
                
                while (webServerRunning) {
                    Socket clientSocket = webServerSocket.accept();
                    webServerExecutor.submit(() -> handleWebRequest(clientSocket));
                }
            } catch (IOException e) {
                System.out.println("Web server error: " + e.getMessage());
            }
        }, "web-server");
        webServerThread.setDaemon(true);
        webServerThread.start();
    }
    
    // Handle web requests
    private void handleWebRequest(Socket clientSocket) {
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(clientSocket.getInputStream()));
             PrintWriter out = new PrintWriter(clientSocket.getOutputStream(), true)) {
            
            String requestLine = reader.readLine();
            if (requestLine == null) return;
            
            String[] requestParts = requestLine.split(" ");
            String method = requestParts[0];
            String path = requestParts[1];
            
            if (method.equals("GET")) {
                if (path.equals("/") || path.equals("/index.html")) {
                    serveWebInterface(out);
                } else if (path.equals("/api/generate-qr")) {
                    handleGenerateQR(out);
                } else if (path.startsWith("/api/avatars")) {
                    handleGetAvatars(out);
                } else if (path.startsWith("/api/profile/")) {
                    handleProfileRequest(path, out);
                } else if (path.startsWith("/api/settings/")) {
                    handleSettingsRequest(path, out);
                } else {
                    serve404(out);
                }
            }
        } catch (IOException e) {
            System.out.println("Web request error: " + e.getMessage());
        } finally {
            try {
                clientSocket.close();
            } catch (IOException e) {
                // Ignore
            }
        }
    }
    
    // Serve the web interface
    private void serveWebInterface(PrintWriter out) {
        String html = generateWebInterfaceHTML();
        
        out.println("HTTP/1.1 200 OK");
        out.println("Content-Type: text/html; charset=UTF-8");
        out.println("Content-Length: " + html.getBytes().length);
        out.println("Connection: close");
        out.println();
        out.println(html);
    }
    
    // Generate QR code
    private void handleGenerateQR(PrintWriter out) {
        String sessionId = UUID.randomUUID().toString();
        String localIp = getLocalIp();
        
        // Create new chat session
        sessions.put(sessionId, new ChatSession(sessionId));
        
        String qrData = "{\"ip\":\"" + localIp + ":" + WEB_PORT + "\",\"session\":\"" + sessionId + "\"}";
        String qrUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="; // Placeholder QR
        
        String response = "{\"qrUrl\":\"" + qrUrl + "\",\"sessionId\":\"" + sessionId + "\",\"serverIp\":\"" + localIp + ":" + WEB_PORT + "\"}";
        
        out.println("HTTP/1.1 200 OK");
        out.println("Content-Type: application/json");
        out.println("Content-Length: " + response.getBytes().length);
        out.println("Connection: close");
        out.println();
        out.println(response);
    }
    
    // Handle avatar requests
    private void handleGetAvatars(PrintWriter out) {
        List<String> avatarUrls = new ArrayList<>();
        for (File file : avatarFiles) {
            avatarUrls.add("/assets/" + file.getName());
        }
        
        String response = "{\"avatars\":[" + String.join(",", avatarUrls.stream().map(url -> "\"" + url + "\"").toArray(String[]::new)) + "]}";
        
        out.println("HTTP/1.1 200 OK");
        out.println("Content-Type: application/json");
        out.println("Content-Length: " + response.getBytes().length);
        out.println("Connection: close");
        out.println();
        out.println(response);
    }
    
    // Handle profile requests
    private void handleProfileRequest(String path, PrintWriter out) {
        String userId = path.substring("/api/profile/".length());
        String response = "{\"profile\":{\"username\":\"User-" + userId.substring(0, 4) + "\",\"avatar\":\"https://ui-avatars.com/api/?name=User&background=random&size=100\",\"bio\":\"\"}}";
        
        out.println("HTTP/1.1 200 OK");
        out.println("Content-Type: application/json");
        out.println("Content-Length: " + response.getBytes().length);
        out.println("Connection: close");
        out.println();
        out.println(response);
    }
    
    // Handle settings requests
    private void handleSettingsRequest(String path, PrintWriter out) {
        String response = "{\"settings\":{\"parentalControls\":false,\"readReceipts\":true,\"activityStatus\":true,\"notifications\":true,\"darkMode\":false}}";
        
        out.println("HTTP/1.1 200 OK");
        out.println("Content-Type: application/json");
        out.println("Content-Length: " + response.getBytes().length);
        out.println("Connection: close");
        out.println();
        out.println(response);
    }
    
    // Serve 404
    private void serve404(PrintWriter out) {
        String html = "<html><body><h1>404 Not Found</h1></body></html>";
        
        out.println("HTTP/1.1 404 Not Found");
        out.println("Content-Type: text/html");
        out.println("Content-Length: " + html.getBytes().length);
        out.println("Connection: close");
        out.println();
        out.println(html);
    }
    
    // Get local IP address
    private String getLocalIp() {
        try {
            return InetAddress.getLocalHost().getHostAddress();
        } catch (Exception e) {
            return "localhost";
        }
    }
    
    // Open web interface in browser
    private void openWebInterface() {
        try {
            Desktop.getDesktop().browse(new URI("http://localhost:" + WEB_PORT));
        } catch (Exception e) {
            addMessage("Could not open web browser: " + e.getMessage(), false);
        }
    }
    
    // Generate web interface HTML
    private String generateWebInterfaceHTML() {
        return "<!DOCTYPE html>" +
               "<html><head><title>Java Chat App</title>" +
               "<style>" +
               "body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }" +
               ".container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }" +
               ".header { text-align: center; margin-bottom: 30px; }" +
               ".btn { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 10px; }" +
               ".btn:hover { background: #0056b3; }" +
               ".status { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin: 20px 0; }" +
               "</style></head>" +
               "<body><div class='container'>" +
               "<div class='header'><h1>üöÄ Java Chat Application</h1><p>Complete Java-based chat system</p></div>" +
               "<div class='status'><strong>‚úÖ Status:</strong> Java application running successfully!</div>" +
               "<h3>Features Available:</h3>" +
               "<ul><li>üí¨ Real-time chat messaging</li>" +
               "<li>üé§ Voice message recording</li>" +
               "<li>üë§ Avatar management</li>" +
               "<li>‚öôÔ∏è Settings and preferences</li>" +
               "<li>üì± QR code room sharing</li>" +
               "<li>üåê Web interface integration</li></ul>" +
               "<h3>Server Information:</h3>" +
               "<p><strong>Chat Server:</strong> Port " + CHAT_PORT + "</p>" +
               "<p><strong>Web Server:</strong> Port " + WEB_PORT + "</p>" +
               "<p><strong>Status:</strong> All systems operational</p>" +
               "<div style='text-align: center; margin-top: 30px;'>" +
               "<button class='btn' onclick='location.reload()'>üîÑ Refresh</button>" +
               "<button class='btn' onclick='window.close()'>‚ùå Close</button>" +
               "</div></div></body></html>";
    }

    // Client handler for chat connections
    private class ClientHandler implements Runnable {
        private final Socket socket;
        private final BufferedReader reader;
        private final BufferedWriter writer;

        ClientHandler(Socket socket) throws IOException {
            this.socket = socket;
            this.reader = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            this.writer = new BufferedWriter(new OutputStreamWriter(socket.getOutputStream()));
        }

        @Override
        public void run() {
            String line;
            try {
                while ((line = reader.readLine()) != null) {
                    broadcast(line, this);
                }
            } catch (IOException ignored) {
            } finally {
                connectedClients.remove(this);
                try { socket.close(); } catch (IOException ignored) {}
            }
        }

        void send(String msg) {
            try {
                writer.write(msg);
                writer.write('\n');
                writer.flush();
            } catch (IOException ignored) {
            }
        }
    }

    private void broadcast(String msg, ClientHandler from) {
        for (ClientHandler client : connectedClients) {
            if (client != from) {
                client.send(msg);
            }
        }
    }

    // Chat Page
    private void showChatPage() {
        VBox chatLayout = new VBox(10);
        chatLayout.setPadding(new Insets(10));

        chatMessages = new VBox(5);
        ScrollPane scrollPane = new ScrollPane(chatMessages);
        scrollPane.setFitToWidth(true);

        TextField input = new TextField();
        input.setPromptText("Type a message");
        Button sendBtn = new Button("Send");
        Button voiceNoteBtn = new Button("üé§ Voice Note");

        sendBtn.setOnAction(e -> {
            String msg = input.getText().trim();
            if (!msg.isEmpty()) {
                addMessage(msg, true);
                input.clear();
            }
        });

        voiceNoteBtn.setOnAction(e -> {
            if (!isRecording) {
                startRecording(voiceNoteBtn);
            } else {
                stopRecordingAndSend(voiceNoteBtn);
            }
        });

        HBox inputBar = new HBox(5, input, sendBtn, voiceNoteBtn);
        chatLayout.getChildren().addAll(scrollPane, inputBar);
        root.setCenter(chatLayout);
    }

    // Add message to chat
    private void addMessage(String text, boolean sentByUser) {
        Label msg = new Label(text);
        msg.setWrapText(true);
        msg.setMaxWidth(300);

        if (sentByUser) {
            msg.setStyle("-fx-background-color: #b2f2bb; -fx-padding: 8; -fx-background-radius: 12;");
            msg.setTranslateX(100);
        } else {
            msg.setStyle("-fx-background-color: #c5d6ff; -fx-padding: 8; -fx-background-radius: 12;");
        }

        chatMessages.getChildren().add(msg);
    }

    // Voice recording methods
    private void startRecording(Button voiceBtn) {
        try {
            AudioFormat format = new AudioFormat(AudioFormat.Encoding.PCM_SIGNED, 16000, 16, 1, 2, 16000, false);
            DataLine.Info info = new DataLine.Info(TargetDataLine.class, format);
            recordingLine = (TargetDataLine) AudioSystem.getLine(info);
            recordingLine.open(format);
            recordingLine.start();
            isRecording = true;
            voiceBtn.setText("üî¥ Stop");

            Thread capture = new Thread(() -> {
                try {
                    AudioInputStream ais = new AudioInputStream(recordingLine);
                    File tmp = new File(System.getProperty("java.io.tmpdir"), "voice_note_" + System.currentTimeMillis() + ".wav");
                    AudioSystem.write(ais, AudioFileFormat.Type.WAVE, tmp);
                } catch (Exception ignored) {
                }
            }, "voice-capture");
            capture.setDaemon(true);
            capture.start();
        } catch (LineUnavailableException e) {
            addMessage("Microphone unavailable", false);
        }
    }

    private void stopRecordingAndSend(Button voiceBtn) {
        try {
            if (recordingLine != null) {
                recordingLine.stop();
                recordingLine.close();
            }
        } catch (Exception ignored) {
        }
        isRecording = false;
        voiceBtn.setText("üé§ Voice Note");

        // Find the latest recorded wav in tmp dir
        try {
            File tmpDir = new File(System.getProperty("java.io.tmpdir"));
            File[] files = tmpDir.listFiles((dir, name) -> name.startsWith("voice_note_") && name.endsWith(".wav"));
            if (files != null && files.length > 0) {
                Arrays.sort(files, Comparator.comparingLong(File::lastModified).reversed());
                File latest = files[0];
                addMessage("üéµ Voice note recorded: " + latest.getName(), true);
            }
        } catch (Exception ignored) {
        }
    }

    // Profile Page
    private void showProfilePage() {
        VBox profileLayout = new VBox(10);
        profileLayout.setPadding(new Insets(10));

        Label avatarLabel = new Label("Your Avatar:");
        profileAvatarView = new ImageView(new Image("https://via.placeholder.com/100"));
        profileAvatarView.setFitWidth(100);
        profileAvatarView.setFitHeight(100);

        Button changeAvatarBtn = new Button("Change Avatar");
        changeAvatarBtn.setOnAction(e -> {
            if (avatarFiles.isEmpty()) return;
            Image current = profileAvatarView.getImage();
            int idx = -1;
            for (int i = 0; i < avatarFiles.size(); i++) {
                Image img = loadAndRemoveBackground(avatarFiles.get(i));
                if (img.equals(current)) { idx = i; break; }
            }
            int next = (idx + 1) % avatarFiles.size();
            profileAvatarView.setImage(loadAndRemoveBackground(avatarFiles.get(next)));
        });

        ScrollPane galleryScroll = new ScrollPane(gallery);
        galleryScroll.setFitToWidth(true);
        galleryScroll.setPrefViewportHeight(150);

        profileLayout.getChildren().addAll(avatarLabel, profileAvatarView, new Label("Choose from assets:"), galleryScroll, changeAvatarBtn);
        root.setCenter(profileLayout);
    }

    private Image loadAndRemoveBackground(File file) {
        try (InputStream in = new FileInputStream(file)) {
            Image image = new Image(in);
            return chromaKeyRemove(image);
        } catch (IOException e) {
            return new Image("https://via.placeholder.com/100");
        }
    }

    // Simple chroma-key background removal
    private Image chromaKeyRemove(Image source) {
        int width = (int) Math.max(1, source.getWidth());
        int height = (int) Math.max(1, source.getHeight());
        javafx.scene.image.WritableImage out = new javafx.scene.image.WritableImage(width, height);
        javafx.scene.image.PixelReader pr = source.getPixelReader();
        javafx.scene.image.PixelWriter pw = out.getPixelWriter();
        if (pr == null) return source;

        // Sample corners for background color
        int[] cx = {0, width - 1, 0, width - 1};
        int[] cy = {0, 0, height - 1, height - 1};
        double br = 0, bg = 0, bb = 0;
        for (int i = 0; i < 4; i++) {
            int x = Math.max(0, cx[i]);
            int y = Math.max(0, cy[i]);
            int argb = pr.getArgb(x, y);
            br += ((argb >> 16) & 0xFF);
            bg += ((argb >> 8) & 0xFF);
            bb += (argb & 0xFF);
        }
        br /= 4.0; bg /= 4.0; bb /= 4.0;

        double threshold = 40.0;

        for (int y = 0; y < height; y++) {
            for (int x = 0; x < width; x++) {
                int argb = pr.getArgb(x, y);
                int a = (argb >> 24) & 0xFF;
                int r = (argb >> 16) & 0xFF;
                int g = (argb >> 8) & 0xFF;
                int b = argb & 0xFF;

                double dr = r - br;
                double dg = g - bg;
                double db = b - bb;
                double distance = Math.sqrt(dr * dr + dg * dg + db * db);

                int newA = a;
                if (distance < threshold) {
                    newA = 0; // make background transparent
                }
                int newArgb = (newA << 24) | (r << 16) | (g << 8) | b;
                pw.setArgb(x, y, newArgb);
            }
        }
        return out;
    }

    // Settings Page
    private void showSettingsPage() {
        VBox settingsLayout = new VBox(10);
        settingsLayout.setPadding(new Insets(10));

        CheckBox parentalControls = new CheckBox("Enable Parental Controls");
        CheckBox readReceipts = new CheckBox("Enable Read Receipts");
        CheckBox activityStatus = new CheckBox("Show If You Are Active");
        CheckBox showNotifications = new CheckBox("Allow Notifications");
        CheckBox darkMode = new CheckBox("Enable Dark Mode");

        Button deleteAccountBtn = new Button("Delete Account");
        Button logOutBtn = new Button("Log Out");

        settingsLayout.getChildren().addAll(
            new Label("Settings:"), 
            parentalControls, 
            readReceipts, 
            activityStatus, 
            showNotifications, 
            darkMode, 
            deleteAccountBtn, 
            logOutBtn
        );
        root.setCenter(settingsLayout);
    }

    // Chat session class
    private static class ChatSession {
        private final String sessionId;
        private final List<String> messages = new ArrayList<>();
        private final Map<String, String> users = new HashMap<>();

        public ChatSession(String sessionId) {
            this.sessionId = sessionId;
        }
    }

    @Override
    public void stop() {
        webServerRunning = false;
        try {
            if (chatServerSocket != null) chatServerSocket.close();
            if (webServerSocket != null) webServerSocket.close();
            if (webServerExecutor != null) webServerExecutor.shutdown();
        } catch (IOException ignored) {}
        if (comPort != null && comPort.isOpen()) {
            comPort.closePort();
        }
    }

    public static void main(String[] args) {
        launch(args);
    }
}
